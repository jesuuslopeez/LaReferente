  name: Deploy to VPS                                                                          
                                                                                               
  on:                                                                                          
    push:                                                                                      
      branches: [main]                                                                         
                                                                                               
  jobs:                                                                                        
    deploy:                                                                                    
      runs-on: ubuntu-latest                                                                   
      steps:                                                                                   
        - name: Deploy via SSH                                                                 
          uses: appleboy/ssh-action@v1.0.0                                                     
          with:                                                                                
            host: ${{ secrets.VPS_HOST }}                                                      
            username: ${{ secrets.VPS_USER }}                                                  
            key: ${{ secrets.VPS_SSH_KEY }}                                                    
            script: |
              cd /var/www/LaReferente
              git pull origin main
              if [ ! -f .env ]; then
                echo "ERROR: .env file not found. Deployment aborted."
                exit 1
              fi
              if ! grep -q "JWT_SECRET=" .env; then
                echo "ERROR: JWT_SECRET not defined in .env. Deployment aborted."
                exit 1
              fi
              docker compose -f docker-compose.prod.yml down
              docker compose -f docker-compose.prod.yml build --no-cache
              docker compose -f docker-compose.prod.yml up -d
