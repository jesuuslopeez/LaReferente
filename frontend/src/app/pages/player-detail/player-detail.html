<section class="player-detail">
  @if (loading()) {
    <section class="player-detail__loading">
      <span class="player-detail__spinner"></span>
      <p>Cargando jugador...</p>
    </section>
  } @else if (error()) {
    <section class="player-detail__error">
      <p>{{ error() }}</p>
      <a routerLink="/jugadores" class="player-detail__btn">Volver a jugadores</a>
    </section>
  } @else if (player()) {
    <!-- Botón volver -->
    <a routerLink="/jugadores" class="player-detail__back">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Volver a jugadores
    </a>

    <!-- Hero Section -->
    <section class="player-detail__hero">
      <!-- Botón Editar (solo editores y admin) -->
      @if (authService.esEditor()) {
        <button class="player-detail__edit-btn" (click)="openEditModal()" title="Editar jugador">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
        </button>
      }

      <section class="player-detail__hero-content">
        <section class="player-detail__photo-container">
          <img
            [src]="getImageUrl(player()!)"
            [alt]="player()!.nombre + ' ' + player()!.apellidos"
            class="player-detail__photo"
            (error)="onImageError($event)"
          />
        </section>

        <section class="player-detail__hero-info">
          <section class="player-detail__badges">
            <span class="player-detail__badge">{{ getPosicionTexto(player()!.posicion) }}</span>
            <span class="player-detail__badge player-detail__badge--outline">{{ getCategoriaTexto(player()!.categoria) }}</span>
          </section>

          <h1 class="player-detail__name">{{ player()!.nombre }} {{ player()!.apellidos }}</h1>

          @if (player()!.dorsal) {
            <p class="player-detail__dorsal-text">Dorsal #{{ player()!.dorsal }}</p>
          }

          <section class="player-detail__hero-stats">
            @if (player()!.equipoNombre && player()!.equipoId) {
              <article class="player-detail__stat">
                <img
                  [src]="getTeamLogoSmall(player()!.equipoId)"
                  [alt]="player()!.equipoNombre"
                  class="player-detail__team-logo"
                  (error)="onTeamLogoError($event)"
                />
                <span>{{ player()!.equipoNombre }}</span>
              </article>
            }
            <article class="player-detail__stat">
              <span [class]="'fi fi-' + getFlagCode(player()!.nacionalidad) + ' player-detail__flag'"></span>
              <span>{{ player()!.nacionalidad }}</span>
            </article>
            @if (player()!.edad) {
              <article class="player-detail__stat">
                <svg class="player-detail__stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span>{{ player()!.edad }} años</span>
              </article>
            }
          </section>

          <section class="player-detail__hero-actions">
            @if (player()!.equipoId) {
              <a [routerLink]="['/equipos', player()!.equipoId]" class="player-detail__action-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
                </svg>
                Ver equipo
              </a>
            }
            <a routerLink="/calendario" class="player-detail__action-btn player-detail__action-btn--outline">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              Ver calendario
            </a>
          </section>
        </section>
      </section>
    </section>

    <!-- Stats Cards -->
    <section class="player-detail__stats-section">
      <h2 class="player-detail__section-title">Características físicas</h2>
      <section class="player-detail__stats-grid">
        @if (player()!.altura) {
          <article class="player-detail__stats-card">
            <svg class="player-detail__stats-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"/>
            </svg>
            <span class="player-detail__stats-card-value">{{ getAlturaMetros(player()!.altura!) }}</span>
            <span class="player-detail__stats-card-label">Altura</span>
          </article>
        }
        @if (player()!.peso) {
          <article class="player-detail__stats-card">
            <svg class="player-detail__stats-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
            </svg>
            <span class="player-detail__stats-card-value">{{ player()!.peso }} kg</span>
            <span class="player-detail__stats-card-label">Peso</span>
          </article>
        }
        @if (player()!.fechaNacimiento) {
          <article class="player-detail__stats-card">
            <svg class="player-detail__stats-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.701 2.701 0 00-1.5-.454M9 6v2m3-2v2m3-2v2M9 3h.01M12 3h.01M15 3h.01M21 21v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7h18zm-3-9v-2a2 2 0 00-2-2H8a2 2 0 00-2 2v2h12z"/>
            </svg>
            <span class="player-detail__stats-card-value">{{ formatDate(player()!.fechaNacimiento) }}</span>
            <span class="player-detail__stats-card-label">Fecha de nacimiento</span>
          </article>
        }
        <article class="player-detail__stats-card">
          <svg class="player-detail__stats-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span class="player-detail__stats-card-value">{{ player()!.nacionalidad }}</span>
          <span class="player-detail__stats-card-label">Nacionalidad</span>
        </article>
      </section>
    </section>

    @if (player()!.biografia) {
      <section class="player-detail__bio">
        <h2 class="player-detail__section-title">Biografía</h2>
        <p class="player-detail__bio-text">{{ player()!.biografia }}</p>
      </section>
    }
  }
</section>

<!-- Modal de Edición -->
@if (showEditModal()) {
  <section class="modal-overlay" [class.modal-overlay--closing]="closingModal()" (click)="closeEditModal()">
    <article class="modal" [class.modal--closing]="closingModal()" (click)="$event.stopPropagation()">
      <header class="modal__header">
        <svg class="modal__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
        </svg>
        <h2 class="modal__title">Editar Jugador</h2>
        <p class="modal__subtitle">Modifica los datos del jugador</p>
      </header>

      <section class="modal__body">
        @if (saveError()) {
          <p class="modal__error">{{ saveError() }}</p>
        }

        <form class="edit-form" (ngSubmit)="savePlayer()">
          <section class="edit-form__row">
            <label class="edit-form__field">
              <span class="edit-form__label">Nombre</span>
              <input
                type="text"
                class="edit-form__input"
                [value]="editForm().nombre"
                (input)="updateFormField('nombre', $any($event.target).value)"
                required
              />
            </label>
            <label class="edit-form__field">
              <span class="edit-form__label">Apellidos</span>
              <input
                type="text"
                class="edit-form__input"
                [value]="editForm().apellidos"
                (input)="updateFormField('apellidos', $any($event.target).value)"
                required
              />
            </label>
          </section>

          <section class="edit-form__row">
            <label class="edit-form__field">
              <span class="edit-form__label">Fecha de nacimiento</span>
              <input
                type="date"
                class="edit-form__input"
                [value]="editForm().fechaNacimiento"
                (input)="updateFormField('fechaNacimiento', $any($event.target).value)"
                required
              />
            </label>
            <section class="edit-form__field edit-form__field--autocomplete">
              <span class="edit-form__label">Nacionalidad</span>
              <section class="autocomplete">
                <input
                  type="text"
                  class="edit-form__input"
                  [class.edit-form__input--invalid]="!paisValido() && paisInput().length > 0"
                  [value]="paisInput()"
                  (input)="onPaisInputChange($any($event.target).value)"
                  (focus)="mostrarPaisSugerencias()"
                  (blur)="ocultarPaisSugerencias()"
                  placeholder="Buscar país..."
                  autocomplete="off"
                />
                @if (showPaisSugerencias() && paisSugerencias().length > 0) {
                  <ul class="autocomplete__list">
                    @for (pais of paisSugerencias(); track pais.es_name) {
                      <li
                        class="autocomplete__item"
                        (mousedown)="seleccionarPais(pais)"
                      >
                        <span class="autocomplete__pais">{{ pais.es_name }}</span>
                        <span class="autocomplete__pais-en">{{ pais.name }}</span>
                      </li>
                    }
                  </ul>
                }
              </section>
              @if (!paisValido() && paisInput().length > 0) {
                <span class="edit-form__hint edit-form__hint--error">Selecciona un país de la lista</span>
              }
            </section>
          </section>

          <section class="edit-form__row">
            <label class="edit-form__field">
              <span class="edit-form__label">Posición</span>
              <select
                class="edit-form__input"
                (change)="updateFormField('posicion', $any($event.target).value)"
                required
              >
                @for (pos of posiciones; track pos.value) {
                  <option [value]="pos.value" [selected]="editForm().posicion === pos.value">{{ pos.label }}</option>
                }
              </select>
            </label>
            <label class="edit-form__field">
              <span class="edit-form__label">Categoría</span>
              <select
                class="edit-form__input"
                (change)="updateFormField('categoria', $any($event.target).value)"
                required
              >
                @for (cat of categorias; track cat.value) {
                  <option [value]="cat.value" [selected]="editForm().categoria === cat.value">{{ cat.label }}</option>
                }
              </select>
            </label>
          </section>

          <section class="edit-form__row">
            <label class="edit-form__field">
              <span class="edit-form__label">Equipo</span>
              <select
                class="edit-form__input"
                (change)="updateFormField('equipoId', +$any($event.target).value || undefined)"
              >
                <option value="" [selected]="!editForm().equipoId">Sin equipo</option>
                @for (team of teams(); track team.id) {
                  <option [value]="team.id" [selected]="editForm().equipoId === team.id">{{ team.nombre }}</option>
                }
              </select>
            </label>
            <label class="edit-form__field">
              <span class="edit-form__label">Dorsal</span>
              <input
                type="number"
                class="edit-form__input"
                [value]="editForm().dorsal"
                (input)="updateFormField('dorsal', +$any($event.target).value || undefined)"
                min="1"
                max="99"
              />
            </label>
          </section>

          <section class="edit-form__row">
            <label class="edit-form__field">
              <span class="edit-form__label">Altura (metros)</span>
              <input
                type="number"
                class="edit-form__input"
                [value]="editForm().altura"
                (input)="updateFormField('altura', +$any($event.target).value || undefined)"
                step="0.01"
                min="1"
                max="2.5"
              />
            </label>
            <label class="edit-form__field">
              <span class="edit-form__label">Peso (kg)</span>
              <input
                type="number"
                class="edit-form__input"
                [value]="editForm().peso"
                (input)="updateFormField('peso', +$any($event.target).value || undefined)"
                min="40"
                max="150"
              />
            </label>
          </section>

          <label class="edit-form__field edit-form__field--full">
            <span class="edit-form__label">Biografía</span>
            <textarea
              class="edit-form__input edit-form__input--textarea"
              [value]="editForm().biografia || ''"
              (input)="updateFormField('biografia', $any($event.target).value || undefined)"
              rows="4"
            ></textarea>
          </label>

          <label class="edit-form__checkbox">
            <input
              type="checkbox"
              [checked]="editForm().activo"
              (change)="updateFormField('activo', $any($event.target).checked)"
            />
            <span>Jugador activo</span>
          </label>
        </form>
      </section>

      <footer class="modal__footer">
        <button type="button" class="modal__btn modal__btn--secondary" (click)="closeEditModal()">
          Cancelar
        </button>
        <button
          type="button"
          class="modal__btn modal__btn--primary"
          (click)="savePlayer()"
          [disabled]="saving()"
        >
          @if (saving()) {
            Guardando...
          } @else {
            Guardar cambios
          }
        </button>
      </footer>
    </article>
  </section>
}
